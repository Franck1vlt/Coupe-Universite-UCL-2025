<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Table de Marquage - Fléchettes</title>
  <link rel="stylesheet" href="flechettes.css">
  <!-- Charger Socket.IO en premier -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- Charger flechettes.js ensuite -->
  <script src="flechettes.js"></script>
  <script>
    // Ajouter cette variable avant les autres déclarations
    let isUpdating = false;
    let matchData = {};
    
    // Intervalle entre les synchronisations HTTP (en millisecondes)
    const SYNC_INTERVAL = 3000;
    let lastUpdateTimestamp = 0;
    
    // Remplacer l'initialisation WebSocket par des fonctions HTTP
    async function fetchMatchData() {
      const matchId = new URLSearchParams(window.location.search).get('matchId');
      if (!matchId) return;
      
      try {
        // Éviter les requêtes en parallèle
        if (isUpdating) return;
        isUpdating = true;
        
        const response = await fetch(`/api/flechettes/match/${matchId}?since=${lastUpdateTimestamp}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Si nous avons des données plus récentes, mettre à jour
        if (data.timestamp > lastUpdateTimestamp) {
          lastUpdateTimestamp = data.timestamp;
          updateFromRemoteData(data);
          console.log('Données du match mises à jour:', data);
        }
        
      } catch (error) {
        console.error('Erreur lors de la récupération des données:', error);
      } finally {
        isUpdating = false;
      }
    }
    
    // Modification à apporter à la fonction sendLiveUpdate dans marquage.html
// Recherchez la fonction et modifiez-la comme suit:

async function sendLiveUpdate() {
  try {
    // Vérifier que tous les éléments nécessaires existent
    const elements = {
      teamAName: document.getElementById('teamAName'),
      teamBName: document.getElementById('teamBName'),
      teamAScore: document.getElementById('teamAScore'),
      teamBScore: document.getElementById('teamBScore'),
      teamASets: document.getElementById('teamASets'),
      teamBSets: document.getElementById('teamBSets'),
      matchType: document.getElementById('matchType'),
      currentPlayer: document.getElementById('currentPlayer')
    };

    // Si un élément requis est manquant, attendre et réessayer
    if (Object.values(elements).some(el => !el)) {
      console.log("Certains éléments ne sont pas encore chargés, nouvelle tentative dans 1s");
      setTimeout(sendLiveUpdate, 1000);
      return;
    }

    // Construire les données avec vérification
    const liveData = {
      team1: elements.teamAName.textContent,
      team2: elements.teamBName.textContent,
      score1: elements.teamAScore.textContent,
      score2: elements.teamBScore.textContent,
      sets: {
        teamA: elements.teamASets.textContent,
        teamB: elements.teamBSets.textContent
      },
      matchType: elements.matchType.textContent,
      currentPlayer: elements.currentPlayer.textContent,
      // Ajout de cette ligne pour transmettre directement l'identifiant du joueur
      currentPlayerId: window.currentPlayer || '1A',
      throwsLeft: window.throwsLeft ? window.throwsLeft[window.currentPlayer] : 3,
      lastUpdate: new Date().toISOString()
    };

    // Sauvegarder dans le localStorage
    localStorage.setItem('liveMatchData', JSON.stringify(liveData));
    console.log("Données mises à jour dans localStorage:", liveData);
    
    // Déclencher un événement personnalisé pour notifier les mises à jour
    window.dispatchEvent(new CustomEvent('liveDataUpdated', { detail: liveData }));

  } catch (error) {
    console.error('Erreur lors de la mise à jour:', error);
  }
}


// De même, modifiez la fonction openScoreDisplay de la même façon:

function openScoreDisplay() {
  try {
    // Récupérer d'abord les éléments avec gestion d'erreur
    const elements = {
      teamAName: document.getElementById('teamAName'),
      teamBName: document.getElementById('teamBName'),
      teamAScore: document.getElementById('teamAScore'),
      teamBScore: document.getElementById('teamBScore'),
      teamASets: document.getElementById('teamASets'),
      teamBSets: document.getElementById('teamBSets'),
      matchType: document.getElementById('matchType'),
      currentPlayer: document.getElementById('currentPlayer')
    };

    // Préparer les données avec valeurs par défaut


    // Sauvegarder dans le localStorage
    localStorage.setItem('liveMatchData', JSON.stringify(liveData));
    console.log("Données mises à jour pour l'affichage:", liveData);
    
    // Ouvrir dans une nouvelle fenêtre avec dimensions spécifiées
    const width = 800;
    const height = 600;
    const left = (screen.width - width) / 2;
    const top = (screen.height - height) / 2;
    
    window.open('affichage_score.html', '_blank');
    
  } catch (error) {
    console.error('Erreur détaillée:', error);
    alert('Erreur lors de l\'ouverture de l\'affichage. Veuillez réessayer.');
  }
}
    // Remplacer la fonction updateFromRemoteData
    function updateFromRemoteData(data) {
        try {
            // Vérifier que tous les éléments nécessaires existent
            const scoreA = document.getElementById('teamAScore');
            const scoreB = document.getElementById('teamBScore');
            const currentPlayerEl = document.getElementById('currentPlayer');

            if (data.score1 && scoreA) {
                scoreA.textContent = data.score1;
            }
            
            if (data.score2 && scoreB) {
                scoreB.textContent = data.score2;
            }
            
            if (data.currentPlayer && currentPlayerEl) {
                currentPlayerEl.textContent = data.currentPlayer;
            }

            // Mise à jour des lancers
            if (data.throwsLeft !== undefined && window.throwsLeft) {
                if (typeof data.throwsLeft === 'object') {
                    window.throwsLeft = {...window.throwsLeft, ...data.throwsLeft};
                } else if (window.currentPlayer) {
                    window.throwsLeft[window.currentPlayer] = data.throwsLeft;
                }
                
                // Ne mettre à jour l'UI que si les éléments existent
                if (window.currentPlayer && window.throwsLeft[window.currentPlayer] !== undefined) {
                    updateThrowsUI();
                }
            }

            // Mise à jour des sets si disponibles
            if (data.sets) {
                const teamASets = document.getElementById('teamASets');
                const teamBSets = document.getElementById('teamBSets');
                
                if (teamASets && data.sets.teamA !== undefined) {
                    teamASets.textContent = data.sets.teamA;
                }
                if (teamBSets && data.sets.teamB !== undefined) {
                    teamBSets.textContent = data.sets.teamB;
                }
            }

        } catch (error) {
            console.error('Erreur détaillée lors de la mise à jour:', error);
            console.log('Données reçues:', data);
            console.log('État actuel:', {
                currentPlayer: window.currentPlayer,
                throwsLeft: window.throwsLeft,
                elementsPresents: {
                    scoreA: !!document.getElementById('teamAScore'),
                    scoreB: !!document.getElementById('teamBScore'),
                    currentPlayer: !!document.getElementById('currentPlayer')
                }
            });
        }
    }
    
    // Afficher visuellement le nombre de lancers restants
    function updateThrowsUI() {
      if (window.currentPlayer && window.throwsLeft) {
        const currentPlayerElement = document.getElementById('currentPlayer');
        if (currentPlayerElement) {
          currentPlayerElement.textContent = `Joueur actuel: ${window.currentPlayer} (${window.throwsLeft[window.currentPlayer]} lancers restants)`;
        }
      }
    }
    
    // Initialisation au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
      // Paramétrer le match depuis l'URL
      const urlParams = new URLSearchParams(window.location.search);
      const team1 = urlParams.get('team1');
      const team2 = urlParams.get('team2');
      
      if (team1) document.getElementById('teamAName').textContent = team1;
      if (team2) document.getElementById('teamBName').textContent = team2;
      
      // Synchronisation périodique automatique - récupération des mises à jour
      setInterval(fetchMatchData, SYNC_INTERVAL);
      
      // Synchronisation périodique automatique - envoi des mises à jour
      setInterval(sendLiveUpdate, SYNC_INTERVAL);
      
      // Attendre que flechettes.js soit complètement chargé
      setTimeout(() => {
        if (typeof window.selectPlayer === 'function') {
          window.selectPlayer("1A");
        } else {
          console.error("La fonction selectPlayer n'est pas disponible");
        }
        
        if (typeof window.updateScoreDisplay === 'function') {
          window.updateScoreDisplay();
        } else {
          console.error("La fonction updateScoreDisplay n'est pas disponible");
        }
      }, 300);
    });

    // Remplacer la fonction openScoreDisplay existante
    function openScoreDisplay() {
        try {
            // Construire les données avec une meilleure gestion des erreurs
            const liveData = {
                team1: document.getElementById('teamAName')?.textContent || 'Team A',
                team2: document.getElementById('teamBName')?.textContent || 'Team B',
                score1: document.getElementById('teamAScore')?.textContent || '301',
                score2: document.getElementById('teamBScore')?.textContent || '301',
                sets: {
                    teamA: document.getElementById('teamASets')?.textContent || '0',
                    teamB: document.getElementById('teamBSets')?.textContent || '0'
                },
                matchType: document.getElementById('matchType')?.textContent || 'Type de Match',
                currentPlayer: document.getElementById('currentPlayer')?.textContent || '1A',
                throwsLeft: window.throwsLeft ? window.throwsLeft[window.currentPlayer] || 3 : 3,
                lastUpdate: new Date().toISOString()
            };

            // Sauvegarder dans le localStorage
            localStorage.setItem('liveMatchData', JSON.stringify(liveData));
            
            // Ouvrir dans une nouvelle fenêtre avec dimensions spécifiées
            const width = 800;
            const height = 600;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            
            window.open('affichage_score.html', '_blank');
            
        } catch (error) {
            console.error('Erreur détaillée:', error);
            alert('Erreur lors de l\'ouverture de l\'affichage. Veuillez réessayer.');
        }
    }

    async function sendLiveUpdate() {
        try {
            // Récupérer d'abord les éléments avec gestion d'erreur
            const elements = {
                teamAName: document.getElementById('teamAName'),
                teamBName: document.getElementById('teamBName'),
                teamAScore: document.getElementById('teamAScore'),
                teamBScore: document.getElementById('teamBScore'),
                teamASets: document.getElementById('teamASets'),
                teamBSets: document.getElementById('teamBSets'),
                matchType: document.getElementById('matchType'),
                currentPlayer: document.getElementById('currentPlayer')
            };

            // Préparer les données avec valeurs par défaut
            const liveData = {
                team1: elements.teamAName?.textContent || 'Team A',
                team2: elements.teamBName?.textContent || 'Team B',
                score1: elements.teamAScore?.textContent || '301',
                score2: elements.teamBScore?.textContent || '301',
                sets: {
                    teamA: elements.teamASets?.textContent || '0',
                    teamB: elements.teamBSets?.textContent || '0'
                },
                matchType: elements.matchType?.textContent || 'Type de Match',
                currentPlayer: elements.currentPlayer?.textContent || '',
                throwsLeft: window.throwsLeft?.[window.currentPlayer] || 3,
                lastUpdate: new Date().toISOString()
            };

            // Sauvegarder dans le localStorage
            localStorage.setItem('liveMatchData', JSON.stringify(liveData));

            // Déclencher un événement personnalisé pour notifier les mises à jour
            window.dispatchEvent(new CustomEvent('liveDataUpdated', { detail: liveData }));

        } catch (error) {
            console.error('Erreur lors de la mise à jour:', error);
        }
    }
  </script>
</head>
<body>
  <header>
    <h1>Fléchettes - Table de marquage</h1>
  </header>
  <main>
    <div class="gauche">
      <div class="parametres-match">
        <label for="teamA">Équipe A :</label>
        <select id="teamA" name="teamA" onchange="updateTeams()">
          <option>Team A</option>
          <option value="ESPOL">ESPOL</option>
          <option value="ESPAS-ESTICE">ESPAS-ESTICE</option>
          <option value="FGES">FGES</option>
          <option value="FLD">FLD</option>
          <option value="FLSH">FLSH</option>
          <option value="FMMS">FMMS</option>
          <option value="ICAM">ICAM</option>
          <option value="IESEG">IESEG</option>
          <option value="IKPO">IKPO</option>
          <option value="ISTC">ISTC</option>
          <option value="JUNIA">JUNIA</option>
          <option value="LiDD">LiDD</option>
          <option value="USCHOOL">USCHOOL</option>
        </select>
        <label for="teamB">Équipe B :</label>
        <select id="teamB" name="teamB" onchange="updateTeams()">
          <option>Team B</option>
          <option value="ESPOL">ESPOL</option>
          <option value="ESPAS-ESTICE">ESPAS-ESTICE</option>
          <option value="FGES">FGES</option>
          <option value="FLD">FLD</option>
          <option value="FLSH">FLSH</option>
          <option value="FMMS">FMMS</option>
          <option value="ICAM">ICAM</option>
          <option value="IESEG">IESEG</option>
          <option value="IKPO">IKPO</option>
          <option value="ISTC">ISTC</option>
          <option value="JUNIA">JUNIA</option>
          <option value="LiDD">LiDD</option>
          <option value="USCHOOL">USCHOOL</option>
        </select>
        <label for="matchType">Type de match :</label>
        <select id="matchTypeSelector" onchange="updateMatchType()">
          <option>Type de match</option>
          <option value="Barrages">Barrages</option>
          <option value="Quart de finale">Quart de finale</option>
          <option value="Demi-finale">Demi-finale</option>
          <option value="Petite Finale">Petite Finale</option>
          <option value="Finale">Finale</option>
          <option value="poule">Poule</option>
        </select>
        <label for="matchGround">Terrain :</label>
        <select id="matchGroundSelector">
          <option>Terrain</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
        </select>
      </div>
      <div class="bouton_pied_page">
        <div class="button-row1">
          <button onclick="location.href='flechettes.html'">Retour</button>
        </div>
        <div class="button-row2">
          <button onclick="openScoreDisplay()">Spectateurs</button>
        </div>
      </div>
    </div>
    <div class="droite">
      <div class="scoreboard">
        <div class="score-display">
          <div class="score-line">
            <span id="teamAName" class="team-name">Team A</span>
            <span id="teamAScore" class="team-score">301</span>
            <div><span id="teamASets">0</span></div>
            <span class="score-divider">-</span>
            <div><span id="teamBSets">0</span></div>
            <span id="teamBScore" class="team-score">301</span>
            <span id="teamBName" class="team-name">Team B</span>
          </div>
          <div class="details-line">
            <span id="matchType" class="match-type">Type de Match</span>
          </div>
          
          <div class="points-line">
            <div id="pointsButtons" class="points-buttons">
                <!-- Les boutons seront générés via JavaScript -->
            </div>
          </div>

          <div class="multiple-points">
            <button class="control-button" onclick="mulScore(1)">x1</button>
            <button class="control-button" onclick="mulScore(2)">x2</button>
            <button class="control-button" onclick="mulScore(3)">x3</button>
            <button class="control-button" onclick="supScore(0)">Manqué</button>
          </div>
          <div class="players">
            <div class="team-a-players">
              <button class="player-button" data-player="1A">1A</button>
              <button class="player-button" data-player="2A">2A</button>
            </div>
            <div class="team-b-players">
              <button class="player-button" data-player="1B">1B</button>
              <button class="player-button" data-player="2B">2B</button>
            </div>
          </div>

          <div class="bottom-controls">
            <button onclick="resetGame()" class="action-button" id="resetGameButton">Terminer</button>
          </div>

        </div>
      </div>
    </div>
  </main>
</body>
</html>
