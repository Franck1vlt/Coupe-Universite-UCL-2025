<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Affichage Score P√©tanque</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #ffffff;
            color: #000000;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        .score-board {
            text-align: center;
            width: 100%;
            padding: 2vh;
        }

        .teams {
            display: flex;
            justify-content: space-around;
            font-size: 5vw;
            margin: 2vh 0;
            font-weight: bold;
        }

        .score-container {
            font-size: 12vw;
            font-weight: bold;
            margin: 4vh 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .ball-icon {
            width: 5vw;
            height: 5vw;
            vertical-align: middle;
        }

        .score-divider {
            margin: 0 4vw;
            color: #000000;
        }

        .match-info {
            font-size: 3vw;
            margin: 3vh 0;
        }

        .team-logo {
            width: 8vw;
            height: 8vw;
            margin: 0 2vw;
            object-fit: contain;
        }

        .current-player {
            margin-top: 3vh;
            font-size: 3vw;
            font-weight: bold;
        }

        .shots-remaining {
            display: flex;
            justify-content: center;
            margin-top: 2vh;
        }

        .shot-indicator {
            width: 1vw;
            height: 5vh;
            background-color: #000;
            margin: 0 1vw;
            border-radius: 0.5vw;
        }

        .team-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Animation pour les changements de score */
        .score-change {
            animation: scoreUpdate 0.5s ease-in-out;
        }

        @keyframes scoreUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Style pour la section d'affichage en deux colonnes */
        .split-view {
            display: flex;
            width: 100%;
        }

        .left-side, .right-side {
            width: 50%;
            padding: 2vh;
            box-sizing: border-box;
        }

        .divider {
            width: 0.3vw;
            background-color: #000;
        }

        .match-type {
            font-size: 2.5vw;
            font-weight: bold;
            margin: 2vh 0;
            color: #333;
            text-transform: uppercase;
        }
    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="score-board">
        <div class="teams">
            <div class="team-container">
                <img src="" alt="" class="team-logo" id="logoB">
                <div id="teamBName">TEAM B</div>
            </div>
            <div class="team-container">
                <img src="" alt="" class="team-logo" id="logoA">
                <div id="teamAName">TEAM A</div>
            </div>
        </div>
        
        <div class="score-container">
            <img src="cochonnet.png" alt="Cochonnet Icon" class="ball-icon" id="ballIconB" style="visibility: hidden;">
            <span id="teamBScore">0</span>
            <span class="score-divider">-</span>
            <span id="teamAScore">0</span>
            <img src="cochonnet.png" alt="Cochonnet Icon" class="ball-icon" id="ballIconA" style="visibility: hidden;">
        </div>
        
        <div class="match-info">
            <span class="match-type" id="matchType">Type de match</span>
        </div>

        <div class="current-player">
            Joueur actuel: <span id="currentPlayer">-</span>
        </div>

        <div class="shots-remaining">
            <div class="shot-indicator" id="shot1"></div>
            <div class="shot-indicator" id="shot2"></div>
            <div class="shot-indicator" id="shot3"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Variable WebSocket
            let socket;
            let socketConnected = false;

            // Initialisation WebSocket
            function initWebSocket() {
                try {
                    if (typeof io === 'undefined') {
                        console.error('Socket.IO non disponible');
                        return;
                    }
                    
                    socket = io();
                    
                    socket.on('connect', () => {
                        console.log('Connect√© au serveur WebSocket');
                        socketConnected = true;
                        // Ajouter un indicateur visuel de connexion
                        showConnectionStatus(true);
                    });
                    
                    socket.on('disconnect', () => {
                        console.log('D√©connect√© du serveur WebSocket');
                        socketConnected = false;
                        showConnectionStatus(false);
                    });
                    
                    // √âcouter les mises √† jour de score
                    socket.on('live_score_update', (data) => {
                        console.log('R√©ception mise √† jour:', data);
                        // Mettre √† jour l'affichage avec les nouvelles donn√©es
                        localStorage.setItem('liveMatchData', JSON.stringify(data));
                        updateDisplay();
                    });
                } catch (error) {
                    console.error('Erreur WebSocket:', error);
                }
            }

            function showConnectionStatus(isConnected) {
                let status = document.getElementById('connectionStatus');
                if (!status) {
                    status = document.createElement('div');
                    status.id = 'connectionStatus';
                    status.style.position = 'fixed';
                    status.style.top = '10px';
                    status.style.right = '10px';
                    status.style.padding = '5px 10px';
                    status.style.borderRadius = '5px';
                    status.style.fontSize = '12px';
                    document.body.appendChild(status);
                }
                
                if (isConnected) {
                    status.textContent = 'üü¢ Connect√©';
                    status.style.backgroundColor = '#d4edda';
                    status.style.color = '#155724';
                } else {
                    status.textContent = 'üî¥ Hors ligne';
                    status.style.backgroundColor = '#f8d7da';
                    status.style.color = '#721c24';
                }
            }

            function updateDisplay() {
                try {
                    const matchData = JSON.parse(localStorage.getItem('liveMatchData') || '{}');
                    console.log("Donn√©es r√©cup√©r√©es:", matchData); // Pour d√©bogage
                    
                    // Mise √† jour des √©quipes et scores
                    document.getElementById('teamAName').textContent = matchData.team1 || 'TEAM A';
                    document.getElementById('teamBName').textContent = matchData.team2 || 'TEAM B';
                    document.getElementById('teamAScore').textContent = matchData.score1 || '301';
                    document.getElementById('teamBScore').textContent = matchData.score2 || '301';
                    
                    // Mise √† jour du joueur actuel
                    const currentPlayerText = matchData.currentPlayer || '';
                    document.getElementById('currentPlayer').textContent = currentPlayerText.replace("Joueur actuel: ", "");
                    
                    // Extraire le nombre de lancers restants du texte
                    let throwsLeft = 3; // Valeur par d√©faut
                    const match = currentPlayerText.match(/\((\d+) lancers? restants?\)/);
                    if (match && match[1]) {
                        throwsLeft = parseInt(match[1]);
                    } else if (matchData.throwsLeft) {
                        // Si disponible dans l'objet directement
                        throwsLeft = parseInt(matchData.throwsLeft);
                    }
                    
                    // Mise √† jour des indicateurs de lancers
                    const indicators = document.querySelectorAll('.shot-indicator');
                    for (let i = 0; i < indicators.length; i++) {
                        indicators[i].style.opacity = i < throwsLeft ? "1" : "0.2";
                    }
                    
                    // Mise √† jour du type de match
                    const matchTypeElement = document.getElementById('matchType');
                    if (matchTypeElement && matchData.matchType) {
                        // Afficher directement la valeur re√ßue
                        matchTypeElement.textContent = matchData.matchType;
                    }
                    
                    // Mise √† jour des logos
                    updateLogo('logoA', matchData.team1);
                    updateLogo('logoB', matchData.team2);
                } catch (error) {
                    console.error("Erreur lors de la mise √† jour de l'affichage:", error);
                }
            }
            
            function updateLogo(id, team) {
                if (!team) return;
                const logo = document.getElementById(id);
                if (logo) {
                    logo.src = `../img/${team}.png`;
                    logo.onerror = () => logo.src = '../img/default.png';
                }
            }

            // Mise √† jour initiale et p√©riodique
            updateDisplay();
            setInterval(updateDisplay, 100);

            // Initialiser WebSocket
            initWebSocket();
        });
    </script>
</body>
</html>