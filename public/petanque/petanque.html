<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P√©tanque</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Fonction pour charger Socket.IO de mani√®re conditionnelle -->
    <script>
        function loadSocketIO() {
            return new Promise((resolve, reject) => {
                // V√©rifier si le serveur est accessible avant de charger Socket.IO
                fetch('/socket.io/socket.io.js', { 
                    method: 'HEAD',
                    cache: 'no-store',
                    signal: AbortSignal.timeout(3000)
                })
                .then(response => {
                    if (response.ok) {
                        // Serveur accessible, charger Socket.IO
                        const script = document.createElement('script');
                        script.src = '/socket.io/socket.io.js';
                        script.onload = () => {
                            console.log('Socket.IO charg√© avec succ√®s');
                            resolve(true);
                        };
                        script.onerror = (error) => {
                            console.error('Erreur lors du chargement de Socket.IO:', error);
                            reject(error);
                        };
                        document.head.appendChild(script);
                    } else {
                        console.warn('Serveur accessible mais retourne une erreur:', response.status);
                        reject(new Error(`Erreur serveur: ${response.status}`));
                    }
                })
                .catch(error => {
                    console.error('Serveur non accessible lors de la tentative de chargement de Socket.IO:', error);
                    reject(error);
                });
            });
        }

        // Essayer de charger Socket.IO, mais continuer m√™me en cas d'√©chec
        loadSocketIO().catch(error => {
            console.warn('Application d√©marr√©e sans Socket.IO:', error);
            // Cr√©er une notification pour l'utilisateur
            document.addEventListener('DOMContentLoaded', () => {
                const offlineNotice = document.createElement('div');
                offlineNotice.id = 'offlineNotice';
                offlineNotice.innerHTML = `
                    <div style="position: fixed; bottom: 20px; right: 20px; background-color: #fff3cd; 
                         color: #856404; padding: 10px; border-radius: 4px; z-index: 1000; 
                         box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                        Mode hors ligne actif - Les donn√©es sont sauvegard√©es localement.
                        <br><small>Serveur non disponible: ${error.message}</small>
                    </div>
                `;
                document.body.appendChild(offlineNotice);
            });
        });
    </script>
<style>
    .correction-button {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #f44336;
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      z-index: 1000;
      transition: all 0.3s ease;
    }

    .correction-button:hover {
      transform: scale(1.1);
      background-color: #d32f2f;
    }

    .match.termin√© {
      cursor: pointer;
    }

    .match.termin√©:hover {
      border: 2px solid #f44336;
    }

    /* Style pour le statut de connexion */
    .connection-status {
        position: fixed;
        top: 20px;
        right: 100px;
        padding: 8px 12px;
        border-radius: 5px;
        font-size: 14px;
        font-weight: bold;
        z-index: 1000;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        min-width: 150px;
    }
    
    .connection-status::before {
        content: '';
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
        background-color: #f8d7da;
    }
    
    .connection-status.connected::before {
        background-color: #28a745;
    }
    
    .connection-status.offline::before {
        background-color: #ffc107;
    }
    
    .connection-status.disconnected::before {
        background-color: #dc3545;
    }
    
    .connection-status.connecting::before {
        background-color: #6c757d;
        animation: pulse 1s infinite;
    }
  </style>
</head>
<body>
    <button id="correctionMode" class="correction-button" onclick="toggleCorrectionMode()">‚úèÔ∏è</button>
    <div class="background-lines"></div>
    <div class="container">
      <header>
        <div class="phase-selector">
          <select id="phaseSelect" class="phase-select">
            <option value="qualification-phase">Barrages</option>
            <option value="final-phase">Phase finale</option>
            <option value="ranking-phase">Classement final</option>
          </select>
        </div>
        <h1>P√©tanque</h1>
        <div class="subtitle">Phase √† √©limination directe</div>
      </header>
        
      <div class="tournament-container">
        <!-- SECTION QUALIFICATIONS -->
        <div class="bracket phase-content" id="qualification-phase">
            <div class="round qualification-round">
            <div class="round-title">Barrages</div>
                <!-- Match 1 -->
                <div class="match-wrapper">
                    <div class="match termin√©" data-match-id="1" data-match-type="barrage">
                    <div class="team">
                        <div class="team-name">ESSLIL</div>
                        <div class="score">-</div>
                    </div>
                    <div class="team">
                        <div class="team-name">USCHOOL</div>
                        <div class="score">-</div>
                    </div>
                    <div class="match-info-container">
                        <div class="match-time">9:30</div>
                        <div class="match-status">√† venir</div>
                    </div>
                    </div>
                    <div class="connector right"></div>
                </div>
                
                <!-- Match 2 -->
                <div class="match-wrapper">
                    <div class="match termin√©" data-match-id="2" data-match-type="barrage">
                    <div class="team">
                        <div class="team-name">LiDD</div>
                        <div class="score">-</div>
                    </div>
                    <div class="team">
                        <div class="team-name">FLD</div>
                        <div class="score">-</div>
                    </div>
                    <div class="match-info-container">
                        <div class="match-time">9:30</div>
                        <div class="match-status">√† venir</div>
                    </div>
                    </div>
                    <div class="connector right"></div>
                </div>
                
                <!-- Match 3 -->
                <div class="match-wrapper">
                    <div class="match termin√©" data-match-id="15" data-match-type="barrage">
                    <div class="team">
                        <div class="team-name">ESPAS-ESTICE</div>
                        <div class="score">-</div>
                    </div>
                    <div class="team">
                        <div class="team-name">ESPOL</div>
                        <div class="score">-</div>
                    </div>
                    <div class="match-info-container">
                        <div class="match-time">10:15</div>
                        <div class="match-status">√† venir</div>
                    </div>
                    </div>
                    <div class="connector right"></div>
                </div>
                
                <!-- Match 4 -->
                <div class="match-wrapper">
                    <div class="match termin√©" data-match-id="16" data-match-type="barrage">
                    <div class="team">
                        <div class="team-name">PIKTURA</div>
                        <div class="score">-</div>
                    </div>
                    <div class="team">
                        <div class="team-name">FLSH</div>
                        <div class="score">-</div>
                    </div>
                    <div class="match-info-container">
                        <div class="match-time">10:15</div>
                        <div class="match-status">√† venir</div>
                    </div>
                    </div>
                    <div class="connector right"></div>
                </div>
            </div>
        </div>

        <!-- SECTION PHASE FINALE -->
        <div class="bracket phase-content" id="final-phase">
            <!-- Quarts de finale -->
            <div class="round">
            <div class="round-title">Quarts de finale</div>
            <!-- Match 1: FMMS vs Gagnant barrage 1 -->
            <div class="match-wrapper">
                <div class="match" data-match-id="3" data-match-type="quarterfinal" data-position="1">
                <div class="team">
                    <div class="team-name">FMMS</div>
                    <div class="score">-</div>
                </div>
                <div class="team">
                    <div class="team-name">-</div>
                    <div class="score">-</div>
                </div>
                <div class="match-info-container">
                    <div class="match-time">11:15</div>
                    <div class="match-status">√† venir</div>
                </div>
                </div>
                <div class="connector top"></div>
            </div>
            <!-- Match 2: FGES vs Gagnant barrage 2 -->
            <div class="match-wrapper">
                <div class="match" data-match-id="4" data-match-type="quarterfinal" data-position="2">
                <div class="team">
                    <div class="team-name">FGES</div>
                    <div class="score">-</div>
                </div>
                <div class="team">
                    <div class="team-name">-</div>
                    <div class="score">-</div>
                </div>
                <div class="match-info-container">
                    <div class="match-time">11:30</div>
                    <div class="match-status">√† venir</div>
                </div>
                </div>
                <div class="connector bottom"></div>
            </div>
            <!-- Match 3: Gagnant barrage 3 vs IKPO -->
            <div class="match-wrapper">
                <div class="match" data-match-id="5" data-match-type="quarterfinal" data-position="3">
                <div class="team">
                    <div class="team-name">-</div>
                    <div class="score">-</div>
                </div>
                <div class="team">
                    <div class="team-name">IKPO</div>
                    <div class="score">-</div>
                </div>
                <div class="match-info-container">
                    <div class="match-time">12:15</div>
                    <div class="match-status">√† venir</div>
                </div>
                </div>
                <div class="connector top"></div>
            </div>
            <!-- Match 4: ICAM vs Gagnant barrage 4 -->
            <div class="match-wrapper">
                <div class="match" data-match-id="6" data-match-type="quarterfinal" data-position="4">
                <div class="team">
                    <div class="team-name">ICAM</div>
                    <div class="score">-</div>
                </div>
                <div class="team">
                    <div class="team-name">-</div>
                    <div class="score">-</div>
                </div>
                <div class="match-info-container">
                    <div class="match-time">12:30</div>
                    <div class="match-status">√† venir</div>
                </div>
                </div>
                <div class="connector bottom"></div>
            </div>
            </div>
            <!-- Demi-finales -->
            <div class="round2">
            <div class="round-title">Demi-finales</div>
            <div class="match-wrapper">
                <div class="match" data-match-id="9" data-match-type="semifinal" data-position="1">
                <div class="team">
                    <div class="team-name">-</div>
                    <div class="score">-</div>
                </div>
                <div class="team">
                    <div class="team-name">-</div>
                    <div class="score">-</div>
                </div>
                <div class="match-info-container">
                    <div class="match-time">13:45</div>
                    <div class="match-status">√† venir</div>
                </div>
                </div>
                <div class="connector top"></div>
            </div>
            <div class="match-wrapper">
                <div class="match" data-match-id="10" data-match-type="semifinal" data-position="2">
                <div class="team">
                    <div class="team-name">-</div>
                    <div class="score">-</div>
                </div>
                <div class="team">
                    <div class="team-name">-</div>
                    <div class="score">-</div>
                </div>
                <div class="match-info-container">
                    <div class="match-time">14:15</div>
                    <div class="match-status">√† venir</div>
                </div>
                </div>
                <div class="connector bottom"></div>
            </div>
            </div>
            <!-- Finale & Petite Finale -->
            <div class="round3">
            <div class="round-title">Finale</div>
            <div class="match-wrapper">
                <div class="match" data-match-id="14" data-match-type="final" data-position="1">
                <div class="team">
                    <div class="team-name">-</div>
                    <div class="score">-</div>
                </div>
                <div class="team">
                    <div class="team-name">-</div>
                    <div class="score">-</div>
                </div>
                <div class="match-info-container">
                    <div class="match-time">16:00</div>
                    <div class="match-status">√† venir</div>
                </div>
                </div>
            </div>
            <div class="small-final">
                <div class="small-final-title">Match pour la 3√®me place</div>
                <div class="match" data-match-id="13" data-match-type="smallfinal" data-position="1">
                <div class="team">
                    <div class="team-name">-</div>
                    <div class="score">-</div>
                </div>
                <div class="team">
                    <div class="team-name">-</div>
                    <div class="score">-</div>
                </div>
                <div class="match-info-container">
                    <div class="match-time">15:15</div>
                    <div class="match-status">√† venir</div>
                </div>
                </div>
            </div>
            </div>
            <!-- Champion -->
            <div class="round4">
            <div class="round-title">Champion</div>
            <div class="trophy">
                <div class="trophy-icon">üèÜ</div>
                <div class="champion" id="champion">√Ä d√©terminer</div>
            </div>
            </div>
        </div>

        <!-- SECTION CLASSEMENT FINAL -->
        <div class="bracket phase-content" id="ranking-phase">
            <div class="ranking-container">
            <div class="round-title">Classement Final P√©tanque</div>
            <div class="ranking-table">
                <div class="ranking-row header">
                <div class="rank">Position</div>
                <div class="teamname">√âquipe</div>
                <div class="points">Points</div>
                </div>
                <div id="rankingList">
                <!-- Rempli dynamiquement par JavaScript -->
                </div>
            </div>
            </div>
        </div>
      </div>
      <div style="text-align: center;">
          <button class="reset-button" id="resetTournament" onclick="resetTournament()">R√©initialiser le tournoi</button>
          <!--<button onclick="simulateTournament()">Simuler la comp√©tition</button>-->
          <button class="back-button" onclick="window.location.href='../index.html'">Retour</button>
      </div>
    </div>
    
    <!-- Ajouter Socket.IO avant tournament.js -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="tournament.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
          const phaseSelect = document.getElementById('phaseSelect');
          const phaseContents = document.querySelectorAll('.phase-content');
          
          phaseSelect.addEventListener('change', async function() {
            const selectedPhase = phaseSelect.value;
            phaseContents.forEach(function(content) {
              if (content.id === selectedPhase) {
                content.classList.remove('hidden');
              } else {
                content.classList.add('hidden');
              }
            });
            
            if (selectedPhase === 'ranking-phase') {
              try {
                await updateRankingDisplay();
              } catch (error) {
                console.error('Erreur lors de la mise √† jour du classement masculin:', error);
              }
            }
          });
          
          // D√©clencher l'√©v√©nement change initial de mani√®re asynchrone
          setTimeout(() => phaseSelect.dispatchEvent(new Event('change')), 0);
        });  
        
        // Ajouter au script existant
        document.addEventListener('DOMContentLoaded', function() {
            // Code existant...
            
            // Surveiller l'√©tat de la connexion au serveur
            const connectionStatus = document.getElementById('connectionStatus');
            
            function updateConnectionStatus(state) {
                if (!connectionStatus) return;
                
                connectionStatus.classList.remove('connected', 'disconnected', 'connecting', 'offline');
                
                if (state === 'connected') {
                    connectionStatus.textContent = 'Connexion: ‚úÖ';
                    connectionStatus.classList.add('connected');
                } else if (state === 'disconnected') {
                    connectionStatus.textContent = 'Connexion: ‚ùå';
                    connectionStatus.classList.add('disconnected');
                } else if (state === 'offline') {
                    connectionStatus.textContent = 'Mode hors ligne';
                    connectionStatus.classList.add('offline');
                } else {
                    connectionStatus.textContent = 'V√©rification...';
                    connectionStatus.classList.add('connecting');
                }
            }
            
            // Remplacer la v√©rification HTTP par WebSocket
            if (socket && socket.connected) {
                updateConnectionStatus('connected');
            } else {
                updateConnectionStatus('connecting');
                socket.once('connect', () => {
                    updateConnectionStatus('connected');
                });
                socket.once('connect_error', () => {
                    updateConnectionStatus('offline');
                });
            }
        });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // Fonction pour mettre √† jour les statuts des matchs
        function updateMatchStatus(status) {
            const matches = document.querySelectorAll('.match');
            matches.forEach(match => {
                const matchStatus = match.querySelector('.match-status');
                if (!matchStatus) return;

                let text = '';
                let bgColor = '';
                let textColor = '';

                switch (status) {
                    case '√†_venir':
                        text = '√Ä venir';
                        bgColor = '#f0f0f0';
                        textColor = '#666';
                        break;
                    case 'en_cours':
                        text = 'En cours';
                        bgColor = '#fff3cd';
                        textColor = '#856404';
                        break;
                    case 'termin√©':
                        text = 'Termin√©';
                        bgColor = '#d4edda';
                        textColor = '#155724';
                        break;
                    default:
                        text = 'Inconnu';
                        bgColor = '#f8d7da';
                        textColor = '#721c24';
                }

                matchStatus.textContent = text;
                matchStatus.style.backgroundColor = bgColor;
                matchStatus.style.color = textColor;
                match.setAttribute('data-status', status);
            });
        }

        // Initialisation des statuts des matchs
        updateMatchStatus('√†_venir');
    });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // D√©tecter si la page a √©t√© recharg√©e avec un param√®tre de rafra√Æchissement
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('refresh')) {
            console.log("Rechargement forc√© d√©tect√©, mise √† jour de l'interface...");
            setTimeout(() => {
                // Forcer le rechargement de l'√©tat du tournoi
                if (typeof loadTournamentState === 'function') {
                    loadTournamentState();
                }
                
                // Recalculer les liens et mettre √† jour l'interface
                if (typeof linkWinnersAndLosers === 'function') {
                    linkWinnersAndLosers();
                }
                
                if (typeof updateUI === 'function') {
                    updateUI();
                }
                
                if (typeof updateMatchClickability === 'function') {
                    updateMatchClickability();
                }
                
                // Aller √† la phase finale
                if (phaseSelect) {
                    phaseSelect.value = 'final-phase';
                    phaseSelect.dispatchEvent(new Event('change'));
                }
            }, 500);
        }
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // D√©tecter si la page a √©t√© recharg√©e avec un param√®tre de rafra√Æchissement
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('refresh')) {
            console.log("Rechargement forc√© d√©tect√©, mise √† jour de l'interface...");
            
            // V√©rifier si on a un statut de match termin√©
            const matchStatus = urlParams.get('matchStatus');
            const matchIdToUpdate = urlParams.get('forceClear');
            const preserveFinished = urlParams.has('preserveFinished');
            
            setTimeout(() => {
                // Forcer le rechargement de l'√©tat du tournoi
                if (typeof loadTournamentState === 'function') {
                    loadTournamentState();
                }
                
                // Si un match sp√©cifique est indiqu√© comme termin√©, mettre √† jour son statut visuel
                if (matchIdToUpdate && matchStatus === 'termine') {
                    console.log(`Mise √† jour forc√©e du statut du match ${matchIdToUpdate} √† 'termin√©'`);
                    
                    // Trouver l'√©l√©ment du match dans le DOM
                    const matchElement = document.querySelector(`.match[data-match-id="${matchIdToUpdate}"]`);
                    if (matchElement) {
                        // Mettre √† jour le statut visuel
                        const statusElement = matchElement.querySelector('.match-status');
                        if (statusElement) {
                            statusElement.textContent = 'Termin√©';
                            statusElement.style.backgroundColor = '#d4edda';
                            statusElement.style.color = '#155724';
                        }
                        
                        // Mettre √† jour l'attribut data-status
                        matchElement.setAttribute('data-status', 'termin√©');
                        
                        console.log(`Statut du match ${matchIdToUpdate} mis √† jour visuellement`);
                    }
                }
                
                // Pr√©server les matchs termin√©s si demand√©
                if (preserveFinished) {
                    // Parcourir tous les matchs avec le statut "termin√©" dans tournamentState
                    // et s'assurer que leur affichage visuel est correct
                    if (typeof tournamentState !== 'undefined' && tournamentState.matches) {
                        Object.entries(tournamentState.matches).forEach(([matchId, matchData]) => {
                            if (matchData.status === 'termin√©') {
                                const matchElement = document.querySelector(`.match[data-match-id="${matchId}"]`);
                                if (matchElement) {
                                    const statusElement = matchElement.querySelector('.match-status');
                                    if (statusElement) {
                                        statusElement.textContent = 'Termin√©';
                                        statusElement.style.backgroundColor = '#d4edda';
                                        statusElement.style.color = '#155724';
                                    }
                                    matchElement.setAttribute('data-status', 'termin√©');
                                    console.log(`Statut pr√©serv√© pour le match termin√© ${matchId}`);
                                }
                            }
                        });
                    }
                }
                
                // V√©rifier si on a des donn√©es de match termin√© dans localStorage
                const lastFinishedMatchData = localStorage.getItem('lastFinishedMatch');
                if (lastFinishedMatchData) {
                    try {
                        const lastMatch = JSON.parse(lastFinishedMatchData);
                        
                        // Ne traiter que les donn√©es r√©centes (moins de 5 minutes)
                        const currentTime = new Date().getTime();
                        const matchTime = lastMatch.timestamp || 0;
                        
                        if (currentTime - matchTime < 5 * 60 * 1000) { // 5 minutes en millisecondes
                            console.log(`Donn√©es r√©centes de match trouv√©es, mise √† jour du match ${lastMatch.matchId}...`);
                            
                            // Mettre √† jour le match dans l'interface
                            const matchElement = document.querySelector(`.match[data-match-id="${lastMatch.matchId}"]`);
                            if (matchElement) {
                                // Mettre √† jour le statut
                                const statusElement = matchElement.querySelector('.match-status');
                                if (statusElement) {
                                    statusElement.textContent = 'Termin√©';
                                    statusElement.style.backgroundColor = '#d4edda';
                                    statusElement.style.color = '#155724';
                                }
                                
                                // Mettre √† jour l'attribut data-status
                                matchElement.setAttribute('data-status', 'termin√©');
                                
                                console.log(`Match ${lastMatch.matchId} mis √† jour √† partir des donn√©es sauvegard√©es`);
                            }
                        }
                        
                        // Nettoyer apr√®s traitement
                        localStorage.removeItem('lastFinishedMatch');
                    } catch (e) {
                        console.error('Erreur lors du traitement des donn√©es de match termin√©:', e);
                    }
                }
                
                // Recalculer les liens et mettre √† jour l'interface
                if (typeof linkWinnersAndLosers === 'function') {
                    linkWinnersAndLosers();
                }
                
                if (typeof updateUI === 'function') {
                    updateUI();
                }
                
                if (typeof updateMatchClickability === 'function') {
                    updateMatchClickability();
                }
                
                // Aller √† la phase finale
                if (phaseSelect) {
                    phaseSelect.value = 'final-phase';
                    phaseSelect.dispatchEvent(new Event('change'));
                }
            }, 500);
        }
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // D√©tecter si la page a √©t√© recharg√©e avec un param√®tre de rafra√Æchissement
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('refresh')) {
            console.log("Rechargement forc√© d√©tect√©, mise √† jour de l'interface...");
            
            // Restaurer les matchs termin√©s sauvegard√©s
            const savedFinishedMatches = localStorage.getItem('petanque_finishedMatches');
            const matchesToRestore = savedFinishedMatches ? JSON.parse(savedFinishedMatches) : {};
            console.log("Matchs termin√©s √† restaurer:", Object.keys(matchesToRestore));
            
            // V√©rifier si on a un statut de match termin√©
            const matchStatus = urlParams.get('matchStatus');
            const matchIdToUpdate = urlParams.get('forceClear');
            
            setTimeout(() => {
                // Forcer le rechargement de l'√©tat du tournoi
                if (typeof loadTournamentState === 'function') {
                    loadTournamentState();
                }
                
                // R√©cup√©rer la copie actuelle du tournoi apr√®s chargement
                const currentState = JSON.parse(localStorage.getItem('petanqueTournamentState') || '{}');
                
                // Si on a un √©tat valide et des matchs √† restaurer
                if (currentState.matches && Object.keys(matchesToRestore).length > 0) {
                    // Restaurer tous les statuts 'termin√©'
                    let changesApplied = false;
                    
                    Object.keys(matchesToRestore).forEach(matchId => {
                        if (currentState.matches[matchId]) {
                            // V√©rifier si le statut a √©t√© modifi√©
                            if (currentState.matches[matchId].status !== 'termin√©') {
                                console.log(`Restauration du statut 'termin√©' pour match ${matchId}`);
                                currentState.matches[matchId].status = 'termin√©';
                                changesApplied = true;
                            }
                        }
                    });
                    
                    // Appliquer √©galement au match nouvellement termin√©
                    if (matchIdToUpdate && matchStatus === 'termine' && currentState.matches[matchIdToUpdate]) {
                        console.log(`Application du statut 'termin√©' pour match ${matchIdToUpdate}`);
                        currentState.matches[matchIdToUpdate].status = 'termin√©';
                        changesApplied = true;
                    }
                    
                    // Sauvegarder l'√©tat mis √† jour
                    if (changesApplied) {
                        console.log("Sauvegarde de l'√©tat modifi√© avec statuts 'termin√©' restaur√©s");
                        localStorage.setItem('petanqueTournamentState', JSON.stringify(currentState));
                    }
                    
                    // Nettoyer la sauvegarde temporaire
                    localStorage.removeItem('petanque_finishedMatches');
                }
                
                // Recalculer les liens et mettre √† jour l'interface
                if (typeof linkWinnersAndLosers === 'function') {
                    linkWinnersAndLosers();
                }
                
                if (typeof updateUI === 'function') {
                    updateUI();
                }
                
                // Mise √† jour de l'interface visuelle
                document.querySelectorAll('.match').forEach(match => {
                    const matchId = match.getAttribute('data-match-id');
                    if (matchId && (matchesToRestore[matchId] || matchId === matchIdToUpdate)) {
                        const statusEl = match.querySelector('.match-status');
                        if (statusEl) {
                            statusEl.textContent = 'Termin√©';
                            statusEl.style.backgroundColor = '#d4edda';
                            statusEl.style.color = '#155724';
                        }
                        match.setAttribute('data-status', 'termin√©');
                    }
                });
                
                if (typeof updateMatchClickability === 'function') {
                    updateMatchClickability();
                }
                
                // Aller √† la phase finale
                if (phaseSelect) {
                    phaseSelect.value = 'final-phase';
                    phaseSelect.dispatchEvent(new Event('change'));
                }
            }, 500);
        }
    });
</script>
</body>
</html>